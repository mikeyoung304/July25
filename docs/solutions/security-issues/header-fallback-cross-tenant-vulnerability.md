---
title: X-Restaurant-ID Header Fallback Vulnerability
category: security-issues
severity: P1
symptoms:
  - Cross-tenant data access possible
  - Security audit finds header fallback pattern
root_cause: Auth middleware allowed X-Restaurant-ID header fallback when JWT missing claim
tags: [security, multi-tenant, auth, headers]
created_date: 2025-11-25
---

# X-Restaurant-ID Header Fallback Vulnerability

## Problem

Auth middleware allowed falling back to `X-Restaurant-ID` header when JWT token was missing `restaurant_id` claim. This allowed authenticated users to access data from ANY restaurant by spoofing the header.

## Bug Pattern

```typescript
// VULNERABLE: Header fallback allows cross-tenant access
req.restaurantId = strictAuth
  ? decoded.restaurant_id
  : (decoded.restaurant_id || (req.headers['x-restaurant-id'] as string));

// ATTACK: Authenticated user sends forged header
curl -H "Authorization: Bearer valid_token" \
     -H "X-Restaurant-ID: victim-restaurant-uuid" \
     /api/v1/orders
// Returns orders from victim restaurant!
```

## Fix Pattern

```typescript
// SECURE: Only trust restaurant_id from JWT token
req.restaurantId = decoded.restaurant_id;

// For public endpoints (unauthenticated), use explicit lookup:
// 1. Validate restaurant exists via database query
// 2. Only expose public data (menu, hours)
// 3. Never trust header for tenant context
```

## Affected Files

- `server/src/middleware/auth.ts` - authenticate(), optionalAuth()
- `server/src/middleware/restaurantAccess.ts` - validateRestaurantAccess()

## Prevention

- Never fall back to request headers for tenant identity
- JWT `restaurant_id` claim is the ONLY source of tenant context
- Test with forged headers to verify isolation
