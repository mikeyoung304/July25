---
title: Test Environment Isolation - CI Test Failures from Vercel CLI Pollution
category: test-failures
severity: high
components: [testing, ci-cd, environment-configuration, vitest, bootstrap]
symptoms:
  - 116 test files failing in CI
  - Tests expecting localhost:3001 but getting production URL
  - Tests expecting UUID restaurant ID but getting slug format
  - Missing DATABASE_URL errors in server tests
  - "Tests pass locally but fail in CI"
root_cause: .env.test file generated by Vercel CLI contained production values instead of test values
tags: [environment-variables, test-setup, ci-cd, vercel, bootstrap, isolation, vitest]
created_date: 2025-12-03
resolution_commit: 2fb587dd
related_lessons: [CL-TEST-001, CL-TEST-002]
---

# Test Environment Isolation - CI Test Failures Fix

## Problem Statement

CI tests were failing (116 test files, 135+ tests) while local tests passed. The root cause was test environment pollution from Vercel CLI overwriting `.env.test` with production configuration.

### Symptoms Observed

1. **Client tests failing** with URL mismatch:
   ```
   Expected: http://localhost:3001/api/v1/realtime/session
   Received: https://july25.onrender.com/api/v1/realtime/session
   ```

2. **Server tests failing** with missing env vars:
   ```
   ❌ ENVIRONMENT VALIDATION FAILED
   - DATABASE_URL: Required
   ```

3. **Restaurant ID format mismatch**:
   ```
   Expected: 11111111-1111-1111-1111-111111111111 (UUID)
   Received: grow (slug)
   ```

## Root Cause Analysis

### The Pollution Chain

```
1. Developer runs `vercel env pull` to get production secrets
2. Vercel CLI creates/overwrites .env.test with production values
3. .env.test was in .gitignore, so changes aren't tracked
4. CI pulls repo, uses polluted .env.test
5. Tests expect test values, get production values → FAIL
```

### Problematic `.env.test` Content (Before Fix)

```env
# Created by Vercel CLI - WRONG VALUES FOR TESTS
NODE_ENV="production"
VITE_API_BASE_URL="https://july25.onrender.com"
VITE_DEFAULT_RESTAURANT_ID="grow"
```

### Missing Bootstrap Variable

`server/tests/bootstrap.ts` was missing:
```typescript
process.env.DATABASE_URL = 'postgresql://...'
```

## Solution

### Step 1: Rename Polluted File

```bash
mv .env.test .env.vercel.development
```

Preserves Vercel config without polluting test environment.

### Step 2: Create Proper `.env.test`

```env
# Test environment configuration
# Required for: npm test, npm run test:client, npm run test:server
# Do NOT use production values here - tests expect these exact values
#
# Note: If Vercel CLI creates a new .env.test, rename it to .env.vercel.*

NODE_ENV=test

# Client test values (must match client/test/setup.ts)
VITE_API_BASE_URL=http://localhost:3001
VITE_SUPABASE_URL=https://test.supabase.co
VITE_SUPABASE_ANON_KEY=test-anon-key
VITE_DEFAULT_RESTAURANT_ID=11111111-1111-1111-1111-111111111111
VITE_ENVIRONMENT=test

# Disable features that interfere with tests
VITE_DEBUG_VOICE=false
VITE_DEMO_PANEL=false
VITE_ENABLE_PERF=false
VITE_USE_MOCK_DATA=true
VITE_USE_REALTIME_VOICE=false
```

### Step 3: Add Missing Bootstrap Variable

**File:** `server/tests/bootstrap.ts`

```typescript
// Configure test environment variables
process.env.NODE_ENV = 'test';
process.env.PORT = '0';
process.env.DATABASE_URL = 'postgresql://test:test@localhost:5432/test_db';  // ← Added
process.env.SUPABASE_URL = 'https://test.supabase.co';
// ... rest of env vars
```

### Step 4: Update `.gitignore`

```gitignore
# Environment files
.env
.env.*
!.env.test          # ← Track test config in Git
!.env.example       # ← Keep example for reference

# Vercel CLI generated files (do not commit)
.env.vercel.*       # ← Ignore Vercel pollution
```

## Verification

```bash
# Server tests
cd server && npx vitest run
# Result: 395 passed ✅

# Client tests
cd client && npx vitest run
# Result: 943 passed ✅

# Full suite
npm test
# Result: 1,338 passed ✅
```

## Prevention Strategies

### 1. Track `.env.test` in Git

The file is now committed, so Vercel CLI can't silently overwrite it.

### 2. Rename Vercel-Generated Files

When running `vercel env pull`:
```bash
vercel env pull
mv .env.test .env.vercel.development  # Immediately rename
git checkout .env.test                 # Restore test config
```

### 3. Add Pre-Flight Check to CI

```yaml
# .github/workflows/test.yml
- name: Verify test environment
  run: |
    grep -q "NODE_ENV=test" .env.test || exit 1
    grep -q "localhost" .env.test || exit 1
```

### 4. Bootstrap Validation

Add to `server/tests/bootstrap.ts`:
```typescript
if (process.env.NODE_ENV !== 'test') {
  throw new Error('Tests must run with NODE_ENV=test');
}
if (process.env.VITE_API_BASE_URL?.includes('render.com')) {
  throw new Error('Production URL detected in test environment');
}
```

## Warning Signs

| Symptom | Likely Cause |
|---------|--------------|
| Tests pass locally, fail in CI | `.env.test` pollution |
| URL mismatch in test output | Production URL in env |
| DATABASE_URL missing | Bootstrap incomplete |
| Restaurant ID format error | UUID vs slug mismatch |
| 100+ test files failing | Environment-wide issue |

## Quick Fix Checklist

When tests fail with environment issues:

- [ ] Check `.env.test` contains `NODE_ENV=test`
- [ ] Check `.env.test` contains `localhost` URLs
- [ ] Check `.env.test` has UUID restaurant ID
- [ ] Run `git diff .env.test` for unexpected changes
- [ ] Run `git checkout .env.test` to restore
- [ ] Verify `server/tests/bootstrap.ts` has all required vars

## Files Modified

| File | Change |
|------|--------|
| `.env.test` | Created with test values |
| `.env.vercel.development` | Renamed from polluted `.env.test` |
| `server/tests/bootstrap.ts` | Added `DATABASE_URL` |
| `.gitignore` | Track `.env.test`, ignore `.env.vercel.*` |

## Related Documentation

- [CL-TEST-001: Module State Test Isolation](.claude/lessons/CL-TEST-001-module-state-test-isolation.md)
- [CL-TEST-002: Vitest Mock Import Timing](.claude/lessons/CL-TEST-002-vitest-mock-import-timing.md)
- [Implementation Plan](plans/fix-test-env-isolation.md)

## Key Takeaway

> **Test configuration must be version-controlled.** If `.env.test` is in `.gitignore`, any tool can overwrite it. Commit test env files and add explicit ignore patterns for tool-generated files.
