openapi: 3.0.3
info:
  title: Restaurant OS API
  version: 6.0.14
  x-last-updated: '2025-10-31'
  description: |
    Restaurant OS provides a comprehensive API for managing restaurant operations including:
    - Point of Sale (POS)
    - Kitchen Display System (KDS)
    - Online ordering and checkout
    - Voice ordering via WebRTC (OpenAI Realtime API)
    - Payment processing (Square integration)
    - Table management
    - Menu management

    ## Authentication

    The API supports dual authentication:
    - **Production**: Supabase JWT (RLS-enforced)
    - **Development**: JWT fallback (demo/PIN/station authentication)

    All authenticated endpoints require an `Authorization: Bearer <token>` header.
    Multi-tenant requests also require `X-Restaurant-ID` header.

    See [Authentication Architecture](../../explanation/architecture/AUTHENTICATION_ARCHITECTURE.md) for details.
  contact:
    name: Restaurant OS Team
    url: https://github.com/mikeyoung304/rebuild-6.0
  license:
    name: Proprietary
servers:
  - url: http://localhost:3001/api/v1
    description: Local development server
  - url: https://production-url/api/v1
    description: Production server
security:
  - BearerAuth: []
tags:
  - name: Authentication
    description: User authentication and session management
  - name: Orders
    description: Order creation and management
  - name: Menu
    description: Menu items and categories
  - name: Payments
    description: Payment processing via Square
  - name: Voice & AI
    description: Voice ordering and AI services via WebRTC
  - name: Tables
    description: Table management for dine-in service
  - name: Health
    description: Health checks and monitoring
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Supabase JWT (production) or custom JWT (demo/PIN/station).
        Include in header: `Authorization: Bearer <token>`
  parameters:
    RestaurantIdHeader:
      name: X-Restaurant-ID
      in: header
      required: true
      description: Restaurant ID for multi-tenant context
      schema:
        type: string
        format: uuid
        example: 11111111-1111-1111-1111-111111111111
    ClientFlowHeader:
      name: X-Client-Flow
      in: header
      required: false
      description: Client flow for telemetry and flow-specific logic
      schema:
        type: string
        enum:
          - online
          - kiosk
          - server
        example: online
  schemas:
    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Error message
          example: Invalid request
        message:
          type: string
          description: Detailed error message
          example: Order ID is required
        code:
          type: string
          description: Error code
          example: VALIDATION_ERROR
        detail:
          type: string
          description: Additional error details
    User:
      type: object
      required:
        - id
        - role
      properties:
        id:
          type: string
          format: uuid
          description: User ID
        email:
          type: string
          format: email
          description: User email (if applicable)
        displayName:
          type: string
          description: User display name
        role:
          type: string
          enum:
            - customer
            - server
            - kitchen
            - expo
            - cashier
            - manager
            - owner
          description: User role in restaurant
        scopes:
          type: array
          items:
            type: string
          description: User permissions/scopes
          example:
            - orders:create
            - orders:read
            - payments:process
    AuthSession:
      type: object
      required:
        - access_token
      properties:
        access_token:
          type: string
          description: JWT access token
        refresh_token:
          type: string
          description: Refresh token (Supabase auth only)
        expires_in:
          type: integer
          description: Token expiration time in seconds
          example: 3600
    MenuItem:
      type: object
      required:
        - id
        - name
        - price
        - restaurant_id
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: Soul Bowl
        description:
          type: string
          example: Fresh greens with grilled chicken and house dressing
        price:
          type: number
          format: float
          example: 12.99
        category:
          type: string
          example: Bowls
        available:
          type: boolean
          default: true
        restaurant_id:
          type: string
          format: uuid
        image_url:
          type: string
          format: uri
          description: Menu item image URL
    OrderItem:
      type: object
      required:
        - menu_item_id
        - quantity
        - price
      properties:
        id:
          type: string
          format: uuid
          description: Order item ID (generated server-side)
        menu_item_id:
          type: string
          format: uuid
          description: Reference to menu_items table
        name:
          type: string
          example: Soul Bowl
        quantity:
          type: integer
          minimum: 1
          example: 2
        price:
          type: number
          format: float
          description: Item price at time of order
          example: 12.99
        subtotal:
          type: number
          format: float
          description: Calculated subtotal (price * quantity)
          example: 25.98
        modifiers:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              name:
                type: string
              price:
                type: number
          description: Item modifiers (e.g., "Extra Cheese")
        special_instructions:
          type: string
          example: No onions
    Order:
      type: object
      required:
        - id
        - restaurant_id
        - order_number
        - status
        - type
        - items
        - subtotal
        - tax
        - total
        - payment_status
      properties:
        id:
          type: string
          format: uuid
        restaurant_id:
          type: string
          format: uuid
        order_number:
          type: string
          example: ORD-1001
        customer_name:
          type: string
          example: John Doe
        customer_phone:
          type: string
          example: +1-555-123-4567
        customer_email:
          type: string
          format: email
        type:
          type: string
          enum:
            - online
            - pickup
            - delivery
          description: Database-valid order type
        status:
          type: string
          enum:
            - new
            - pending
            - confirmed
            - preparing
            - ready
            - picked-up
            - completed
            - cancelled
          description: Order lifecycle status
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItem'
        subtotal:
          type: number
          format: float
          description: Sum of all item subtotals
        tax:
          type: number
          format: float
          description: Tax amount
        tip:
          type: number
          format: float
          description: Tip amount (optional)
        total:
          type: number
          format: float
          description: Grand total (subtotal + tax + tip)
        payment_status:
          type: string
          enum:
            - unpaid
            - paid
            - failed
            - refunded
          description: Payment lifecycle status (matches database CHECK constraint)
        payment_method:
          type: string
          enum:
            - cash
            - card
            - online
            - other
        table_number:
          type: string
          example: T5
        seat_number:
          type: integer
          description: Seat number for multi-seat ordering
        notes:
          type: string
          example: Extra napkins please
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        estimated_ready_time:
          type: string
          format: date-time
        scheduled_pickup_time:
          type: string
          format: date-time
          description: For scheduled orders
        is_scheduled:
          type: boolean
          description: Whether order is scheduled for future
    CreateOrderRequest:
      type: object
      required:
        - items
      properties:
        items:
          type: array
          items:
            type: object
            required:
              - menu_item_id
              - quantity
              - price
            properties:
              menu_item_id:
                type: string
                format: uuid
              quantity:
                type: integer
                minimum: 1
              price:
                type: number
              modifiers:
                type: array
                items:
                  type: object
              special_instructions:
                type: string
        customer_name:
          type: string
        customer_phone:
          type: string
        customer_email:
          type: string
          format: email
        type:
          type: string
          enum:
            - online
            - pickup
            - delivery
          default: online
        table_number:
          type: string
        seat_number:
          type: integer
        notes:
          type: string
        payment_method:
          type: string
          enum:
            - cash
            - card
            - online
            - other
        scheduled_pickup_time:
          type: string
          format: date-time
    PaymentRequest:
      type: object
      required:
        - order_id
        - token
      properties:
        order_id:
          type: string
          format: uuid
          description: Order ID to process payment for
        token:
          type: string
          description: Square payment token (from Square Web Payments SDK)
        amount:
          type: number
          format: float
          description: |
            Payment amount (OPTIONAL - server validates and recalculates).
            Server NEVER trusts client-provided amounts.
        idempotency_key:
          type: string
          description: |
            Unique key to prevent duplicate charges (OPTIONAL - server generates if not provided).
            Format: UUID v4
        verification_token:
          type: string
          description: 3D Secure verification token (if applicable)
    CashPaymentRequest:
      type: object
      required:
        - order_id
        - amount_received
      properties:
        order_id:
          type: string
          format: uuid
        amount_received:
          type: number
          format: float
          description: Amount of cash received from customer
          example: 20
        table_id:
          type: string
          format: uuid
          description: Table ID (if dine-in payment)
    Table:
      type: object
      required:
        - id
        - restaurant_id
        - label
        - status
      properties:
        id:
          type: string
          format: uuid
        restaurant_id:
          type: string
          format: uuid
        label:
          type: string
          example: T5
        capacity:
          type: integer
          minimum: 1
          example: 4
        status:
          type: string
          enum:
            - available
            - occupied
            - reserved
            - cleaning
        x:
          type: number
          description: X position for floor plan (frontend property)
        'y':
          type: number
          description: Y position for floor plan (frontend property)
        type:
          type: string
          enum:
            - rectangle
            - circle
            - square
          description: Table shape (frontend property, maps to 'shape' in DB)
        z_index:
          type: integer
          description: Z-index for layering
        section:
          type: string
          example: Patio
        current_order_id:
          type: string
          format: uuid
          description: Current order associated with table
        active:
          type: boolean
          default: true
        created_at:
          type: string
          format: date-time
  responses:
    UnauthorizedError:
      description: Authentication required or failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Invalid email or password
            code: UNAUTHORIZED
paths:
  /api/v1/menu:
    post:
      tags:
        - Ai
      summary: Create menu
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
    get:
      tags:
        - Ai
      summary: Get menu
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/transcribe:
    post:
      tags:
        - Ai
      summary: Create transcribe
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/transcribe-with-metadata:
    post:
      tags:
        - Ai
      summary: Create transcribe-with-metadata
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/parse-order:
    post:
      tags:
        - Ai
      summary: Create parse-order
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/voice-chat:
    post:
      tags:
        - Ai
      summary: Create voice-chat
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/chat:
    post:
      tags:
        - Ai
      summary: Create chat
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/health:
    get:
      tags:
        - Ai
      summary: Get health
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/test-tts:
    post:
      tags:
        - Ai
      summary: Create test-tts
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/test-transcribe:
    post:
      tags:
        - Ai
      summary: Create test-transcribe
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/demo-session:
    post:
      tags:
        - Auth
      summary: Create demo-session
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/login:
    post:
      tags:
        - Auth
      summary: Create login
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/pin-login:
    post:
      tags:
        - Auth
      summary: Create pin-login
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/station-login:
    post:
      tags:
        - Auth
      summary: Create station-login
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/logout:
    post:
      tags:
        - Auth
      summary: Create logout
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/me:
    get:
      tags:
        - Auth
      summary: Get me
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/refresh:
    post:
      tags:
        - Auth
      summary: Create refresh
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/set-pin:
    post:
      tags:
        - Auth
      summary: Create set-pin
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/revoke-stations:
    post:
      tags:
        - Auth
      summary: Create revoke-stations
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/:
    get:
      tags:
        - Health
      summary: Get resource
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
    post:
      tags:
        - Orders
      summary: Create resource
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/status:
    get:
      tags:
        - Health
      summary: Get status
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/ready:
    get:
      tags:
        - Health
      summary: Get ready
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/live:
    get:
      tags:
        - Health
      summary: Get live
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/healthz:
    get:
      tags:
        - Health
      summary: Get healthz
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/items:
    get:
      tags:
        - Menu
      summary: Get items
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/items/{id}:
    get:
      tags:
        - Menu
      summary: Get items
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/categories:
    get:
      tags:
        - Menu
      summary: Get categories
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/sync-ai:
    post:
      tags:
        - Menu
      summary: Create sync-ai
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/cache/clear:
    post:
      tags:
        - Menu
      summary: Create clear
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/metrics:
    post:
      tags:
        - Metrics
      summary: Create metrics
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/health/detailed:
    get:
      tags:
        - Metrics
      summary: Get detailed
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/test/error:
    post:
      tags:
        - Metrics
      summary: Create error
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/voice:
    post:
      tags:
        - Orders
      summary: Create voice
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/{id}:
    get:
      tags:
        - Orders
      summary: Get resource
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
    delete:
      tags:
        - Orders
      summary: Delete resource
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
    put:
      tags:
        - Tables
      summary: Update resource
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/{id}/status:
    patch:
      tags:
        - Orders
      summary: Modify status
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/create:
    post:
      tags:
        - Payments
      summary: Create create
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/cash:
    post:
      tags:
        - Payments
      summary: Create cash
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/{paymentId}:
    get:
      tags:
        - Payments
      summary: Get resource
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/{paymentId}/refund:
    post:
      tags:
        - Payments
      summary: Create refund
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/session:
    post:
      tags:
        - Realtime
      summary: Create session
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/events:
    get:
      tags:
        - Security
      summary: Get events
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/stats:
    get:
      tags:
        - Security
      summary: Get stats
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/test:
    post:
      tags:
        - Security
      summary: Create test
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/config:
    get:
      tags:
        - Security
      summary: Get config
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/batch:
    put:
      tags:
        - Tables
      summary: Update batch
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/checkout:
    post:
      tags:
        - Terminal
      summary: Create checkout
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/checkout/{checkoutId}:
    get:
      tags:
        - Terminal
      summary: Get checkout
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/checkout/{checkoutId}/cancel:
    post:
      tags:
        - Terminal
      summary: Create cancel
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/checkout/{checkoutId}/complete:
    post:
      tags:
        - Terminal
      summary: Create complete
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/devices:
    get:
      tags:
        - Terminal
      summary: Get devices
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/payments:
    post:
      tags:
        - Webhook
      summary: Create payments
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/orders:
    post:
      tags:
        - Webhook
      summary: Create orders
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
  /api/v1/inventory:
    post:
      tags:
        - Webhook
      summary: Create inventory
      responses:
        '200':
          description: Successful response
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Server error
      security:
        - bearerAuth: []
