# Quick Win 3: Remove Anonymous WebSocket Connections

**Status**: ‚úÖ COMPLETE
**Duration**: 10 minutes
**Risk Level**: üî¥ HIGH (closes critical security vulnerability)

---

## Summary

Removed anonymous WebSocket connection bypass in dev/test environments that allowed unauthenticated access with default restaurant context, eliminating data leakage and unauthorized access risks.

---

## Changes Made

### Modified Files

**File**: `server/src/middleware/auth.ts`
**Function**: `verifyWebSocketAuth()` (Lines 162-204)

#### Change: Removed Anonymous Connection Bypass
- **Lines**: 170-179
- **Before**:
  ```typescript
  if (!token) {
    if (config.nodeEnv === 'production') {
      logger.warn('WebSocket auth rejected: no token in production');
      return null;
    }
    logger.warn('‚ö†Ô∏è WebSocket: Anonymous connection (no token) - non-production only');
    return {
      userId: 'anonymous',
      restaurantId: config.restaurant.defaultId,
    };
  }
  ```
- **After**:
  ```typescript
  if (!token) {
    // Always reject connections without token (all environments)
    // Security fix P0.9: Removed anonymous connection bypass for dev/test
    // Tests must provide valid JWT tokens via ?token=xxx query parameter
    logger.warn('WebSocket auth rejected: no token provided', {
      environment: config.nodeEnv,
      path: request.url
    });
    return null;
  }
  ```
- **Reason**: Anonymous WebSocket connections create multiple security risks: (1) Bypass of authentication system allows unauthorized real-time data access, (2) Data leakage via default restaurant context gives access to production restaurant data, (3) Creates inconsistent auth model where REST requires JWT but WebSocket doesn't in dev/test.
- **Risk**: **ELIMINATES** critical security vulnerability (CVE-class issue)

---

## Security Impact

### Vulnerability Fixed: Unauthenticated WebSocket Access (CVE-class)

**Severity**: üî¥ CRITICAL
**Attack Vector**: Direct Connection Without Authentication
**CVSS Score**: ~7.8 (High) - Unauthenticated access to real-time order data

#### Before Fix (Anonymous Connections Allowed)
1. **Bypass Authentication**: Any client could connect to WebSocket without token in dev/test
2. **Default Restaurant Access**: Anonymous connections received `userId: 'anonymous'` with `restaurantId: config.restaurant.defaultId`
3. **Data Leakage**: Real-time order updates, KDS events, and cart operations accessible without auth
4. **Attack Scenario**:
   - Attacker discovers WebSocket endpoint (ws://server/voice or similar)
   - Connects without providing ?token= query parameter
   - In dev/test environments, gains full read/write access to default restaurant data
   - Can observe orders, manipulate cart state, inject voice commands
5. **Environment Confusion**: Code deployed to staging with NODE_ENV=development exposes production data

#### After Fix (Token Required)
1. **Consistent Auth Model**: All environments require valid JWT token via ?token=xxx
2. **No Bypass**: Connection rejected immediately if no token provided
3. **Audit Trail**: All WebSocket connections now have authenticated userId
4. **Test Compliance**: Tests must use proper JWT tokens, enforcing security best practices

### Real-World Impact

**Development/Staging Environments**:
- Previous implementation: CRITICAL RISK - Anonymous access to production restaurant data via default restaurantId
- Current implementation: SECURE - All connections authenticated, consistent with production

**Production Environment**:
- Previous implementation: SAFE (bypass only activated in non-production)
- Current implementation: SAFE (no behavior change in production)

**Key Risk Eliminated**: Environment variable misconfiguration (NODE_ENV set incorrectly) no longer creates security hole.

---

## Verification

### Pre-Fix Behavior
```bash
# Old code allowed anonymous connections in dev/test
# Example: WebSocket client connects without ?token= query param
# Result in dev/test: { userId: 'anonymous', restaurantId: 'default-restaurant-id' }
# Result in production: Connection rejected
```

### Post-Fix Behavior
```bash
# New code ALWAYS requires token (all environments)
# Example: WebSocket client connects without ?token= query param
# Result (all environments): Connection rejected, logged warning
```

### TypeScript Compilation
```bash
npx tsc --noEmit
# Result: ‚úÖ No errors (no type changes, pure logic fix)
```

### Test Coverage
```bash
# Search for WebSocket tests
grep -r "websocket\|WebSocket" server/tests/
# Result: No WebSocket tests found

# Glob for WebSocket test files
find server/tests -name "*websocket*.test.ts"
# Result: No files found
```

**Test Coverage Gap Identified**: No automated tests exist for WebSocket authentication. This is a **Phase 2 priority** to add integration tests verifying:
1. Connection rejected without token
2. Connection rejected with invalid token
3. Connection rejected with expired token
4. Connection accepted with valid token
5. restaurantId correctly extracted from token

### Manual QA Steps

**Test 1: Connection Rejected Without Token**
1. Start server in development mode
2. Attempt WebSocket connection without ?token= query parameter
3. **Expected**: Connection rejected
4. **Expected Log**: "WebSocket auth rejected: no token provided"

**Test 2: Connection Requires Valid JWT**
1. Create valid JWT token (can use test token from orders.auth.test.ts helper)
2. Connect to WebSocket with ?token=<valid_jwt>
3. **Expected**: Connection accepted
4. **Expected**: userId extracted from token.sub, restaurantId from token.restaurant_id

**Test 3: Expired Token Rejected**
1. Create expired JWT token
2. Attempt connection with ?token=<expired_jwt>
3. **Expected**: Connection rejected
4. **Expected Log**: "WebSocket auth rejected: invalid token"

---

## Production Deployment Notes

### Breaking Change for Tests
**IMPORTANT**: Any tests or development scripts that relied on anonymous WebSocket connections will now fail.

**Migration Required**:
- Update all WebSocket connection code to include valid JWT token
- Use test token helper from `server/tests/routes/orders.auth.test.ts`:
  ```typescript
  function createTestToken(payload: { role: string; sub?: string; restaurant_id?: string }): string {
    const secret = 'test-jwt-secret';
    return jwt.sign({ sub: payload.sub || 'test-user', role: payload.role, restaurant_id: payload.restaurant_id || 'default-restaurant-id' }, secret, { algorithm: 'HS256', expiresIn: '15m' });
  }
  ```

### No Database Changes
- No schema changes required
- No data migration needed
- Zero downtime deployment

### Monitoring
Add monitoring for WebSocket auth rejections to detect misconfigured clients:
```javascript
logger.warn('WebSocket auth rejected: no token provided', {
  environment: config.nodeEnv,
  path: request.url
});
```

**Alert Threshold**: If rejection rate > 5% of connection attempts, investigate client misconfiguration.

### Rollback Plan
If legitimate clients are unexpectedly rejected (extremely unlikely):
1. Revert to previous commit
2. Deploy within 5 minutes
3. Investigate why clients lack valid tokens
4. Fix client-side token acquisition
5. Re-deploy this fix

---

## Dependencies/Blockers

### Phase 2 Priority: Add WebSocket Auth Tests
**Estimated Effort**: 2 hours

**Required Tests**:
1. Integration test for WebSocket connection with valid token
2. Integration test for connection rejection without token
3. Integration test for connection rejection with invalid/expired token
4. Unit test for token extraction from query parameter
5. Unit test for restaurantId extraction from decoded JWT

**Blocked By**: None - can proceed immediately after Quick Win 3 completion

### Stakeholder Decision Required: Voice Ordering WebSocket
**Question**: Does voice ordering WebSocket endpoint require authentication in kiosk mode?

**Context**: Kiosks may not have user JWT tokens during anonymous browsing. Two options:
1. **Strict Auth** (current implementation): Kiosk must obtain kiosk-specific JWT (e.g., role: 'customer', sub: 'kiosk:<device_id>')
2. **Public Voice Endpoint**: Create separate public WebSocket endpoint for voice ordering with IP-based rate limiting

**Recommendation**: Option 1 (Strict Auth) - Issue device-specific JWT tokens to kiosks at boot/registration time.

---

## Related Security Issues

This fix addresses Issue #3 from AUTH_WEBSOCKET_MULTITENANCY_AUDIT.md. Related issues still pending:

1. **WebSocket connection state not cleaned up** (Phase 2) - Memory leak risk from abandoned connections
2. **No rate limiting on WebSocket endpoints** (Phase 2) - DoS vulnerability
3. **Silent database failures in auth logging** (Phase 2) - 7 locations with no error checking

---

## Next Steps

Quick Win 3 complete. Proceed to:
1. **Create Phase 2+ punch-list** - Document dependencies/blockers for remaining P0 issues
2. **Update synthesis document** - Add all Quick Win changes, test evidence, residual risks
