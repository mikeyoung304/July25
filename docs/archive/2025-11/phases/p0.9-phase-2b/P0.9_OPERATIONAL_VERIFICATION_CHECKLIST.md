# ARCHIVED

> **⚠️ ARCHIVED DOCUMENTATION**
> This file has been archived on 2025-11-14.
> For current documentation, see [docs/README.md](../../../../README.md)
> Category: P0.9 Phase 2B

---

# P0.9 Operational Verification Checklist

**Purpose**: Verify all operational requirements are met before considering P0.9 complete
**Owner**: DevOps / SRE Team
**Target Completion**: Before Phase 2B production deployment

---

## Phase 2A Requirements (Completed Code, Pending Ops)

### 1. Log Rotation for Auth Audit Fallback

**Requirement**: Phase 2A added file-based fallback logging for auth events when database is unavailable.

**Log Files Created**:
- `/var/log/grow/auth_failures.log` (or `{PROJECT_ROOT}/logs/auth_failures.log`)
- Format: JSON lines (newline-delimited)

**Verification Steps**:
- [ ] Log directory exists: `/var/log/grow/` or `{PROJECT_ROOT}/logs/`
- [ ] Log file can be created/written by application user
- [ ] Log rotation configured (recommend: daily, 30-day retention)
- [ ] Disk space monitoring alerts configured

**Log Rotation Configuration** (logrotate):
```
/var/log/grow/auth_failures.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 grow-app grow-app
    sharedscripts
    postrotate
        systemctl reload grow-server > /dev/null 2>&1 || true
    endscript
}
```

**Verification Command**:
```bash
# Test log rotation
sudo logrotate -f /etc/logrotate.d/grow-auth
ls -lh /var/log/grow/auth_failures.log*
```

**Status**: ⏳ PENDING

---

### 2. Monitoring Alerts for Phase 2A

**Requirement**: 4 new critical alerts for silent failure detection

#### Alert 1: PIN Attempt Counter Failure
- **Trigger**: Log message contains "Failed to update PIN attempt counter"
- **Severity**: CRITICAL
- **Action**: Page on-call engineer immediately
- **Reason**: Brute force protection broken
- **Metric**: `auth_pin_attempt_counter_failures_total`

**Prometheus Query**:
```promql
increase(auth_pin_attempt_counter_failures_total[5m]) > 0
```

**Status**: ⏳ PENDING

#### Alert 2: Failed to Load User Permissions
- **Trigger**: Log message contains "Failed to load user permissions"
- **Severity**: CRITICAL
- **Action**: Alert security team
- **Reason**: RBAC enforcement broken
- **Metric**: `auth_permission_load_failures_total`

**Prometheus Query**:
```promql
increase(auth_permission_load_failures_total[5m]) > 0
```

**Status**: ⏳ PENDING

#### Alert 3: Auth Log DB Failed
- **Trigger**: Log message contains "Auth log DB failed"
- **Severity**: ERROR
- **Action**: Alert ops team within 5 minutes
- **Reason**: Audit trail using fallback (compliance risk)
- **Metric**: `auth_log_fallback_total`

**Prometheus Query**:
```promql
rate(auth_log_fallback_total[15m]) > 0.01
```

**Status**: ⏳ PENDING

#### Alert 4: Failed to Update Station Token Activity
- **Trigger**: Log message contains "Failed to update station token activity"
- **Severity**: WARNING
- **Action**: Create ticket for investigation
- **Reason**: Activity tracking degraded
- **Metric**: `station_token_activity_update_failures_total`

**Prometheus Query**:
```promql
increase(station_token_activity_update_failures_total[1h]) > 5
```

**Status**: ⏳ PENDING

---

### 3. Metrics Export Configuration

**Requirement**: Application must export metrics for Prometheus/Grafana

**Metrics to Add**:
```typescript
// In server/src/services/auth/pinAuth.ts
import { Counter } from 'prom-client';

const pinAttemptCounterFailures = new Counter({
  name: 'auth_pin_attempt_counter_failures_total',
  help: 'Total failed PIN attempt counter updates'
});

const permissionLoadFailures = new Counter({
  name: 'auth_permission_load_failures_total',
  help: 'Total failed user permission loads'
});

const authLogFallbacks = new Counter({
  name: 'auth_log_fallback_total',
  help: 'Total auth log fallbacks to file'
});
```

**Verification**:
- [ ] Metrics endpoint exists: `GET /metrics`
- [ ] All 4 auth metrics present in /metrics output
- [ ] Prometheus scraping configured
- [ ] Grafana dashboard created

**Status**: ⏳ PENDING

---

### 4. Log Reconciliation Process

**Requirement**: Process to restore fallback logs to database when recovered

**Script Location**: `scripts/reconcile-auth-logs.sh` (to be created)

**Functionality**:
1. Read auth_failures.log
2. Parse JSON entries
3. Insert into `auth_logs` table
4. Mark entries as reconciled
5. Archive processed log file

**Pseudo-code**:
```bash
#!/bin/bash
# Read fallback log
cat /var/log/grow/auth_failures.log | while read line; do
  # Parse JSON
  echo "$line" | jq -r '...'

  # Insert into DB
  psql -c "INSERT INTO auth_logs (...) VALUES (...)"

  # Archive on success
done

# Rotate processed log
mv /var/log/grow/auth_failures.log /var/log/grow/auth_failures.log.processed
```

**Verification**:
- [ ] Script created
- [ ] Script tested on sample data
- [ ] Cron job configured (daily at 2am)
- [ ] Error handling tested

**Status**: ⏳ PENDING

---

## Phase 2B Requirements (New Additions)

### 5. Security Audit Log Table

**Requirement**: Phase 2B WebSocket security requires new database table

**Migration SQL** (to be run):
```sql
-- Create security_audit_logs table for cross-restaurant violation tracking
CREATE TABLE IF NOT EXISTS security_audit_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  event_type TEXT NOT NULL,
  user_id TEXT NOT NULL,
  authenticated_restaurant_id TEXT NOT NULL,
  attempted_restaurant_id TEXT NOT NULL,
  session_id TEXT,
  ip_address TEXT,
  user_agent TEXT,
  severity TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Indexes for efficient querying
CREATE INDEX idx_security_audit_user_id ON security_audit_logs(user_id);
CREATE INDEX idx_security_audit_created_at ON security_audit_logs(created_at);
CREATE INDEX idx_security_audit_severity ON security_audit_logs(severity);
CREATE INDEX idx_security_audit_event_type ON security_audit_logs(event_type);

-- Comment
COMMENT ON TABLE security_audit_logs IS
'Phase 2B: Security violations including cross-restaurant access attempts';
```

**Verification**:
- [ ] Migration file created: `supabase/migrations/YYYYMMDD_security_audit_logs.sql`
- [ ] Migration tested on staging
- [ ] Migration applied to production
- [ ] Table accessible by application

**Status**: ⏳ PENDING

---

### 6. Security Violation Monitoring

**Requirement**: Alert on ANY cross-restaurant access attempt

#### Alert 5: Cross-Restaurant Access Attempt
- **Trigger**: ANY entry in `security_audit_logs` table
- **Severity**: CRITICAL
- **Action**: Page security team immediately
- **Reason**: Potential security breach or compromised credentials
- **Metric**: `security_violations_total`

**Prometheus Query**:
```promql
increase(security_violations_total[1m]) > 0
```

**Verification**:
- [ ] Metric exported by application
- [ ] Alert configured in PagerDuty/OpsGenie
- [ ] Alert tested (manual test violation)
- [ ] Runbook created for on-call

**Status**: ⏳ PENDING

---

### 7. Security Violation Fallback Logging

**Requirement**: File-based fallback when `security_audit_logs` DB insert fails

**Log File**: `/var/log/grow/security_violations.log`

**Verification**:
- [ ] Log directory has correct permissions
- [ ] Application can write to file
- [ ] Log rotation configured (keep indefinitely)
- [ ] SIEM integration configured (high priority)

**Security Note**: This log contains CRITICAL security events. Ensure:
- Read-only for application user
- Forwarded to external SIEM (Splunk/DataDog/etc.)
- Immutable after writing (append-only file system if possible)
- Encrypted at rest

**Status**: ⏳ PENDING

---

### 8. Grafana Dashboard for Security Violations

**Requirement**: Real-time dashboard for security monitoring

**Panels to Include**:
1. Cross-restaurant access attempts (time series)
2. Top violating users (table)
3. Top attempted restaurants (pie chart)
4. Violation severity distribution (gauge)
5. Hourly violation rate (heatmap)

**Dashboard JSON**: `grafana/dashboards/security-violations.json` (to be created)

**Verification**:
- [ ] Dashboard created
- [ ] Dashboard accessible to security team
- [ ] Dashboard on TV monitors in NOC
- [ ] Dashboard alerts configured

**Status**: ⏳ PENDING

---

## Configuration Verification

### 9. Environment Variables

**Requirement**: All required environment variables set in all environments

**Variables to Check**:
- [ ] `JWT_SECRET` - Required (not optional) after Phase 2A
- [ ] `PIN_PEPPER` - Should NOT use default
- [ ] `STATION_SECRET` - Should NOT use default
- [ ] `STRICT_AUTH` - Recommended: `true` for production
- [ ] `AUTH_ACCEPT_KIOSK_DEMO_ALIAS` - Recommended: `false` (deprecated)
- [ ] `DATABASE_URL` - Valid Supabase connection
- [ ] `NODE_ENV` - Set correctly per environment

**Verification Script**:
```bash
#!/bin/bash
# Check critical env vars
for var in JWT_SECRET PIN_PEPPER STATION_SECRET; do
  if [ -z "${!var}" ]; then
    echo "❌ $var is not set"
    exit 1
  elif [[ "${!var}" == *"default"* ]]; then
    echo "⚠️ $var uses default value (insecure)"
    exit 1
  else
    echo "✅ $var is set"
  fi
done
```

**Status**: ⏳ PENDING

---

### 10. Dead Code Cleanup

**Requirement**: Remove legacy/dead code paths per user directive

**Files Scanned**:
- [x] `server/src/middleware/auth.ts`
- [x] `server/src/middleware/authRateLimiter.ts`
- [x] `server/src/services/auth/pinAuth.ts`
- [x] `server/src/services/auth/stationAuth.ts`

**Dead Code Found**: ✅ NONE

**Verification**:
```bash
grep -r "TODO.*remove\|FIXME\|XXX\|HACK\|dev.*test.*bypass" \
  server/src/middleware/auth*.ts \
  server/src/services/auth/*.ts
# Result: No matches (clean)
```

**Legacy Features Removed** (Phase 1):
- Anonymous WebSocket connections (Quick Win 3) ✅
- Test token bypasses (deprecated) ✅
- kiosk_demo role (aliased to customer) ✅

**Status**: ✅ COMPLETE

---

## Pre-Deployment Final Checks

### 11. Staging Environment Validation

**Requirement**: Full validation in staging before production deployment

**Checklist**:
- [ ] All Phase 2A code deployed to staging
- [ ] All Phase 2B code deployed to staging
- [ ] Database migrations applied
- [ ] Full test suite passes (npm test)
- [ ] Manual QA scenarios completed:
  - [ ] PIN authentication with DB failure simulation
  - [ ] Cross-restaurant access attempt (WebSocket)
  - [ ] Auth log fallback triggered and verified
  - [ ] Security violation logged
- [ ] Performance testing (no regressions)
- [ ] 24-hour soak test completed

**Status**: ⏳ PENDING

---

### 12. Production Deployment Preparation

**Requirement**: All prerequisites met before production deployment

**Checklist**:
- [ ] Change control ticket created
- [ ] Deployment window scheduled (low-traffic period)
- [ ] On-call engineer available
- [ ] Rollback plan tested
- [ ] Database backup verified (< 1 hour old)
- [ ] Monitoring dashboards open
- [ ] PagerDuty silences removed
- [ ] Deployment runbook followed
- [ ] Post-deployment verification plan ready

**Status**: ⏳ PENDING

---

## Post-Deployment Verification

### 13. Production Health Check (First Hour)

**Checklist**:
- [ ] Application started successfully
- [ ] Zero authentication failures (no regressions)
- [ ] Auth log fallback NOT triggered (DB healthy)
- [ ] Security violations = 0 (no false positives)
- [ ] /metrics endpoint returning data
- [ ] Prometheus scraping successfully
- [ ] No ERROR logs related to auth changes
- [ ] Response times normal (< 200ms p95)

**Status**: ⏳ PENDING

---

### 14. Production Soak Test (First Week)

**Monitoring**:
- [ ] Auth failure rate < 0.1% (normal)
- [ ] PIN authentication working for all restaurants
- [ ] WebSocket connections stable
- [ ] Zero cross-restaurant violations (unless legitimate attack)
- [ ] Log files not growing unexpectedly
- [ ] Database auth_logs table receiving entries
- [ ] No CPU/memory regressions

**Status**: ⏳ PENDING

---

## Sign-Off

### Operations Team Sign-Off
- [ ] All log rotation configured
- [ ] All monitoring alerts configured
- [ ] All metrics exporting correctly
- [ ] Database migrations reviewed and approved
- [ ] Runbooks created for all new alerts

**Signed**: ________________ **Date**: __________

### Security Team Sign-Off
- [ ] Cross-restaurant isolation verified
- [ ] Audit trails complete
- [ ] Security violation monitoring configured
- [ ] Penetration testing completed (optional)
- [ ] No critical vulnerabilities remaining

**Signed**: ________________ **Date**: __________

### Engineering Team Sign-Off
- [ ] All code reviewed
- [ ] All tests passing
- [ ] Documentation complete
- [ ] Technical debt minimized
- [ ] No known critical bugs

**Signed**: ________________ **Date**: __________

---

## Summary Status

| Category | Total Items | Complete | Pending |
|----------|-------------|----------|---------|
| **Phase 2A Ops** | 4 items | 1 | 3 |
| **Phase 2B Ops** | 4 items | 0 | 4 |
| **Configuration** | 2 items | 1 | 1 |
| **Deployment** | 3 items | 0 | 3 |
| **Total** | **13 items** | **2** | **11** |

**Overall Readiness**: 15% (2/13 complete)

**Estimated Time to Complete**: 8-16 hours (operational work)

---

## Next Steps

1. **Immediate** (This Sprint):
   - Create database migration for security_audit_logs table
   - Set up log rotation for new log files
   - Configure basic monitoring alerts

2. **This Week**:
   - Export Prometheus metrics
   - Create Grafana dashboards
   - Deploy to staging and validate

3. **Before Production**:
   - Complete all pre-deployment checks
   - Get sign-offs from all teams
   - Schedule deployment window

---

**Document Owner**: Engineering Team
**Last Updated**: 2025-11-11
**Next Review**: After Phase 2B code complete
