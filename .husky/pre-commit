#!/usr/bin/env bash
. "$(dirname "$0")/_/husky.sh"

echo "[husky] pre-commit: quick typecheck + lint"

# Allow skipping on local emergency fixes:
#   SKIP_PRECOMMIT_TS=1 git commit -m "..."
if [ -z "$SKIP_PRECOMMIT_TS" ]; then
  npm run typecheck:quick --workspaces || exit 1
fi

npm run lint --workspaces --silent || exit 1

# Check for console.log statements (Per Technical Roadmap Phase 0)
# Excludes:
#   - tests/reporters/* (Playwright reporters need console.log for terminal output)
#   - scripts/* (CLI/build scripts legitimately use console.log)
echo "[husky] Checking for console.log statements..."
JS_FILES=$(git diff --cached --name-only | grep -E '\.(js|jsx|ts|tsx)$' | grep -v 'tests/reporters/' | grep -v '^scripts/' || true)
if [ -n "$JS_FILES" ]; then
  if echo "$JS_FILES" | xargs grep -l 'console\.\(log\|debug\)' 2>/dev/null; then
    echo ""
    echo "âŒ ERROR: console.log or console.debug found in staged files!"
    echo "   Use 'logger' from 'utils/logger' instead"
    echo "   This is enforced per Technical Roadmap Phase 0"
    echo ""
    echo "To fix: Replace console.log with logger.info"
    echo "To commit anyway (NOT recommended): git commit --no-verify"
    echo ""
    exit 1
  fi
fi

# Validate GitHub Actions workflows
if git diff --cached --name-only | grep -q "^\.github/workflows/.*\.yml$"; then
  echo "ğŸ” Workflow files detected, validating..."
  npm run validate:workflows
fi

# Check for schema drift and RPC types if staging migration files
if git diff --cached --name-only | grep -q "^supabase/migrations/.*\.sql$"; then
  echo "ğŸ” Migration files detected, running validation..."

  # Get list of migration files being committed
  MIGRATION_FILES=$(git diff --cached --name-only | grep "^supabase/migrations/.*\.sql$")

  # Check for common RPC type mistakes (Per Technical Roadmap Phase 1)
  echo "  â†’ Checking RPC function types..."
  RPC_ERRORS=()

  for file in $MIGRATION_FILES; do
    # Skip rollback files
    if [[ "$file" == *"rollback"* ]]; then
      continue
    fi

    # Check if file contains RPC function
    if grep -q "CREATE.*FUNCTION\|CREATE OR REPLACE FUNCTION" "$file"; then
      # Check for VARCHAR (should be TEXT)
      if grep -q "RETURNS TABLE" "$file" && grep -q "VARCHAR" "$file"; then
        RPC_ERRORS+=("$file: Uses VARCHAR - should be TEXT for Prisma compatibility")
      fi

      # Check for TIMESTAMP without TZ (should be TIMESTAMPTZ)
      if grep -q "RETURNS TABLE" "$file" && grep -E "(^|[^A-Z])TIMESTAMP([^TZ]|$)" "$file"; then
        RPC_ERRORS+=("$file: Uses TIMESTAMP - should be TIMESTAMPTZ")
      fi
    fi
  done

  # Report RPC type errors
  if [ ${#RPC_ERRORS[@]} -gt 0 ]; then
    echo ""
    echo "âŒ RPC type errors found:"
    printf '  - %s\n' "${RPC_ERRORS[@]}"
    echo ""
    echo "Common fixes:"
    echo "  - Change VARCHAR to TEXT"
    echo "  - Change TIMESTAMP to TIMESTAMPTZ"
    echo ""
    echo "To commit anyway: git commit --no-verify"
    echo ""
    exit 1
  fi
  echo "  âœ… RPC types valid"

  # Check for Prisma schema sync
  echo "  â†’ Checking Prisma schema sync..."
  if ! git diff --cached --name-only | grep -q "^prisma/schema.prisma$"; then
    echo ""
    echo "âš ï¸  WARNING: Migration files staged but Prisma schema not updated!"
    echo ""
    echo "Action required:"
    echo "  1. Run: ./scripts/post-migration-sync.sh"
    echo "  2. Review changes: git diff prisma/schema.prisma"
    echo "  3. Stage schema: git add prisma/schema.prisma"
    echo "  4. Retry commit"
    echo ""
    echo "To commit anyway: git commit --no-verify"
    echo ""
    exit 1
  fi
  echo "  âœ… Prisma schema included"

  # Check for schema drift
  if command -v supabase &> /dev/null; then
    echo "  â†’ Checking for schema drift..."
    if ! supabase db diff --linked > /dev/null 2>&1; then
      echo ""
      echo "âš ï¸  WARNING: Schema drift detected!"
      echo ""
      echo "Migrations should be deployed BEFORE committing:"
      echo "  supabase db push --linked"
      echo ""
      echo "To commit anyway: git commit --no-verify"
      echo ""
      exit 1
    fi
    echo "  âœ… Schema in sync"
  else
    echo "  âš ï¸  Supabase CLI not found, skipping schema drift check"
    echo "     Install: brew install supabase/tap/supabase"
  fi

  echo "âœ… All migration checks passed"
fi

# Documentation validation (fast checks only)
if git diff --cached --name-only | grep -q "\.md$"; then
  echo ""
  echo "ğŸ“š Validating documentation..."

  # Check for root-level documentation accumulation (warning only)
  echo "  â†’ Checking root-level file count..."
  LEGITIMATE_FILES=("README.md" "CONTRIBUTING.md" "SECURITY.md" "index.md" "onward.md")
  total_root_files=$(find . -maxdepth 1 -name "*.md" -type f | wc -l | tr -d ' ')

  if [ $total_root_files -gt 15 ]; then
    echo ""
    echo "âŒ ERROR: Too many root-level .md files ($total_root_files)"
    echo "   Maximum recommended: 10-12"
    echo "   Run: npm run docs:cleanup"
    echo ""
    echo "To commit anyway: git commit --no-verify"
    echo ""
    exit 1
  elif [ $total_root_files -gt 12 ]; then
    echo "  âš ï¸  Warning: $total_root_files root-level .md files (consider cleanup)"
  fi

  # Check for orphaned files (critical - blocks commit)
  echo "  â†’ Checking for orphaned files..."
  if ! node scripts/docs-check.js --orphans-only 2>/dev/null; then
    echo "  â„¹ï¸  Orphan check skipped (script not found)"
  fi

  # Check timestamps on modified docs (warning only - doesn't block)
  echo "  â†’ Checking timestamps on staged files..."
  if ! node scripts/check-timestamps.js --staged 2>/dev/null; then
    echo "  â„¹ï¸  Timestamp check skipped (script not found)"
  fi

  # Check table formatting on modified docs (critical - blocks commit)
  echo "  â†’ Checking table formatting..."
  STAGED_MD_FILES=$(git diff --cached --name-only | grep "\.md$" | tr '\n' ' ')
  if [ ! -z "$STAGED_MD_FILES" ]; then
    if ! node scripts/check-tables.js $STAGED_MD_FILES 2>/dev/null; then
      echo "  â„¹ï¸  Table check skipped (script not found)"
    fi
  fi

  echo "  âœ… Documentation validation passed"
fi

# Environment variable validation
if git diff --cached --name-only | grep -qE "\.env|\.env\.example|src/config/env"; then
  echo ""
  echo "ğŸ” Validating environment configuration..."

  # Run validation script
  if [ -f scripts/validate-env.cjs ]; then
    if ! node scripts/validate-env.cjs; then
      echo ""
      echo "âŒ Environment validation failed!"
      echo "   Fix the issues above or use: git commit --no-verify"
      echo ""
      exit 1
    fi
  else
    echo "  âš ï¸  Validation script not found, skipping..."
  fi

  echo "  âœ… Environment validation passed"
fi

# Claude Lessons 3.0 Integration
echo ""
echo "ğŸ“ Checking for relevant lessons..."

# Get staged files
STAGED_FILES=$(git diff --cached --name-only)

if [ -n "$STAGED_FILES" ]; then
  # Check if lessons CLI exists
  if [ -f claude-lessons3/scripts/lessons-cli.cjs ]; then
    # Initialize counters
    CRITICAL_FILES=0
    HIGH_FILES=0

    # Check each staged file
    while IFS= read -r file; do
      # Run lessons find for each file
      LESSON_OUTPUT=$(node claude-lessons3/scripts/lessons-cli.cjs find "$file" 2>/dev/null)

      # Check if lessons were found
      if echo "$LESSON_OUTPUT" | grep -q "Risk Level"; then
        echo ""
        echo "  ğŸ“– Lessons for: $file"
        echo "$LESSON_OUTPUT" | grep -E "Risk Level:|Lessons:|Estimated Cost:|Key Anti-Patterns:" | sed 's/^/    /'

        # Count by risk level
        if echo "$LESSON_OUTPUT" | grep -q "Risk Level:.*critical"; then
          CRITICAL_FILES=$((CRITICAL_FILES + 1))
        elif echo "$LESSON_OUTPUT" | grep -q "Risk Level:.*high"; then
          HIGH_FILES=$((HIGH_FILES + 1))
        fi
      fi
    done <<< "$STAGED_FILES"

    # Show summary if critical files detected
    if [ $CRITICAL_FILES -gt 0 ] || [ $HIGH_FILES -gt 0 ]; then
      echo ""
      echo "  âš ï¸  Summary: $CRITICAL_FILES critical, $HIGH_FILES high-risk files"
      echo "     Review relevant lessons before committing"
      echo "     Run: node claude-lessons3/scripts/lessons-cli.cjs find <file>"
    fi

    echo ""
    echo "  â„¹ï¸  Lessons are advisory (non-blocking)"
  else
    echo "  â„¹ï¸  Lessons CLI not found, skipping lesson suggestions"
  fi
else
  echo "  â„¹ï¸  No files staged"
fi

echo ""
echo "âœ… Pre-commit checks complete"

# ============================================================================
# STRICT MODE: Critical File Protection (BLOCKING)
# ============================================================================
if [ -f claude-lessons3/.file-mappings.json ]; then
  CRITICAL_FOUND=""
  for file in $(git diff --cached --name-only); do
    if grep -q "\"$file\"" claude-lessons3/.file-mappings.json 2>/dev/null; then
      if grep -A3 "\"$file\"" claude-lessons3/.file-mappings.json | grep -q '"risk_level": "critical"'; then
        CRITICAL_FOUND="$CRITICAL_FOUND\n  ğŸ”´ $file"
      fi
    fi
  done
  
  if [ -n "$CRITICAL_FOUND" ]; then
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "â›” CRITICAL FILES DETECTED - Review required"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo -e "$CRITICAL_FOUND"
    echo ""
    echo "To commit: LESSONS_ACK=1 git commit -m \"message\""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    [ -z "$LESSONS_ACK" ] && exit 1
    echo "âœ… Acknowledged"
  fi
fi

