#!/usr/bin/env bash
. "$(dirname "$0")/_/husky.sh"

echo "[husky] pre-commit: quick typecheck + lint"

# Allow skipping on local emergency fixes:
#   SKIP_PRECOMMIT_TS=1 git commit -m "..."
if [ -z "$SKIP_PRECOMMIT_TS" ]; then
  npm run typecheck:quick --workspaces || exit 1
fi

npm run lint --workspaces --silent || exit 1

# Check for console.log statements (Per Technical Roadmap Phase 0)
echo "[husky] Checking for console.log statements..."
if git diff --cached --name-only | grep -E '\.(js|jsx|ts|tsx)$' | xargs grep -l 'console\.\(log\|debug\)' 2>/dev/null; then
  echo ""
  echo "‚ùå ERROR: console.log or console.debug found in staged files!"
  echo "   Use 'logger' from 'utils/logger' instead"
  echo "   This is enforced per Technical Roadmap Phase 0"
  echo ""
  echo "To fix: Replace console.log with logger.info"
  echo "To commit anyway (NOT recommended): git commit --no-verify"
  echo ""
  exit 1
fi

# Validate GitHub Actions workflows
if git diff --cached --name-only | grep -q "^\.github/workflows/.*\.yml$"; then
  echo "üîç Workflow files detected, validating..."
  npm run validate:workflows
fi

# Check for schema drift and RPC types if staging migration files
if git diff --cached --name-only | grep -q "^supabase/migrations/.*\.sql$"; then
  echo "üîç Migration files detected, running validation..."

  # Get list of migration files being committed
  MIGRATION_FILES=$(git diff --cached --name-only | grep "^supabase/migrations/.*\.sql$")

  # Check for common RPC type mistakes (Per Technical Roadmap Phase 1)
  echo "  ‚Üí Checking RPC function types..."
  RPC_ERRORS=()

  for file in $MIGRATION_FILES; do
    # Skip rollback files
    if [[ "$file" == *"rollback"* ]]; then
      continue
    fi

    # Check if file contains RPC function
    if grep -q "CREATE.*FUNCTION\|CREATE OR REPLACE FUNCTION" "$file"; then
      # Check for VARCHAR (should be TEXT)
      if grep -q "RETURNS TABLE" "$file" && grep -q "VARCHAR" "$file"; then
        RPC_ERRORS+=("$file: Uses VARCHAR - should be TEXT for Prisma compatibility")
      fi

      # Check for TIMESTAMP without TZ (should be TIMESTAMPTZ)
      if grep -q "RETURNS TABLE" "$file" && grep -P "\\bTIMESTAMP\\b(?!TZ)" "$file"; then
        RPC_ERRORS+=("$file: Uses TIMESTAMP - should be TIMESTAMPTZ")
      fi
    fi
  done

  # Report RPC type errors
  if [ ${#RPC_ERRORS[@]} -gt 0 ]; then
    echo ""
    echo "‚ùå RPC type errors found:"
    printf '  - %s\n' "${RPC_ERRORS[@]}"
    echo ""
    echo "Common fixes:"
    echo "  - Change VARCHAR to TEXT"
    echo "  - Change TIMESTAMP to TIMESTAMPTZ"
    echo ""
    echo "To commit anyway: git commit --no-verify"
    echo ""
    exit 1
  fi
  echo "  ‚úÖ RPC types valid"

  # Check for Prisma schema sync
  echo "  ‚Üí Checking Prisma schema sync..."
  if ! git diff --cached --name-only | grep -q "^prisma/schema.prisma$"; then
    echo ""
    echo "‚ö†Ô∏è  WARNING: Migration files staged but Prisma schema not updated!"
    echo ""
    echo "Action required:"
    echo "  1. Run: ./scripts/post-migration-sync.sh"
    echo "  2. Review changes: git diff prisma/schema.prisma"
    echo "  3. Stage schema: git add prisma/schema.prisma"
    echo "  4. Retry commit"
    echo ""
    echo "To commit anyway: git commit --no-verify"
    echo ""
    exit 1
  fi
  echo "  ‚úÖ Prisma schema included"

  # Check for schema drift
  if command -v supabase &> /dev/null; then
    echo "  ‚Üí Checking for schema drift..."
    if ! supabase db diff --linked > /dev/null 2>&1; then
      echo ""
      echo "‚ö†Ô∏è  WARNING: Schema drift detected!"
      echo ""
      echo "Migrations should be deployed BEFORE committing:"
      echo "  supabase db push --linked"
      echo ""
      echo "To commit anyway: git commit --no-verify"
      echo ""
      exit 1
    fi
    echo "  ‚úÖ Schema in sync"
  else
    echo "  ‚ö†Ô∏è  Supabase CLI not found, skipping schema drift check"
    echo "     Install: brew install supabase/tap/supabase"
  fi

  echo "‚úÖ All migration checks passed"
fi

# Documentation validation (fast checks only)
if git diff --cached --name-only | grep -q "\.md$"; then
  echo ""
  echo "üìö Validating documentation..."

  # Check for root-level documentation accumulation (warning only)
  echo "  ‚Üí Checking root-level file count..."
  LEGITIMATE_FILES=("README.md" "CONTRIBUTING.md" "SECURITY.md" "index.md" "onward.md")
  total_root_files=$(find . -maxdepth 1 -name "*.md" -type f | wc -l | tr -d ' ')

  if [ $total_root_files -gt 15 ]; then
    echo ""
    echo "‚ùå ERROR: Too many root-level .md files ($total_root_files)"
    echo "   Maximum recommended: 10-12"
    echo "   Run: npm run docs:cleanup"
    echo ""
    echo "To commit anyway: git commit --no-verify"
    echo ""
    exit 1
  elif [ $total_root_files -gt 12 ]; then
    echo "  ‚ö†Ô∏è  Warning: $total_root_files root-level .md files (consider cleanup)"
  fi

  # Check for orphaned files (critical - blocks commit)
  echo "  ‚Üí Checking for orphaned files..."
  if ! node scripts/docs-check.js --orphans-only 2>/dev/null; then
    echo "  ‚ÑπÔ∏è  Orphan check skipped (script not found)"
  fi

  # Check timestamps on modified docs (warning only - doesn't block)
  echo "  ‚Üí Checking timestamps on staged files..."
  if ! node scripts/check-timestamps.js --staged 2>/dev/null; then
    echo "  ‚ÑπÔ∏è  Timestamp check skipped (script not found)"
  fi

  # Check table formatting on modified docs (critical - blocks commit)
  echo "  ‚Üí Checking table formatting..."
  STAGED_MD_FILES=$(git diff --cached --name-only | grep "\.md$" | tr '\n' ' ')
  if [ ! -z "$STAGED_MD_FILES" ]; then
    if ! node scripts/check-tables.js $STAGED_MD_FILES 2>/dev/null; then
      echo "  ‚ÑπÔ∏è  Table check skipped (script not found)"
    fi
  fi

  echo "  ‚úÖ Documentation validation passed"
fi

# Environment variable validation
if git diff --cached --name-only | grep -qE "\.env|\.env\.example|src/config/env"; then
  echo ""
  echo "üîê Validating environment configuration..."

  # Run validation script
  if [ -f scripts/validate-env.js ]; then
    if ! node scripts/validate-env.js; then
      echo ""
      echo "‚ùå Environment validation failed!"
      echo "   Fix the issues above or use: git commit --no-verify"
      echo ""
      exit 1
    fi
  else
    echo "  ‚ö†Ô∏è  Validation script not found, skipping..."
  fi

  echo "  ‚úÖ Environment validation passed"
fi
