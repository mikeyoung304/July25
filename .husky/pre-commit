#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Check for OpenAI imports in client code
echo "🔍 Checking for OpenAI imports in client code..."
if grep -r "from 'openai'" client/src --exclude-dir=node_modules 2>/dev/null; then
  echo "❌ Error: Direct OpenAI imports found in client code!"
  echo "OpenAI must only be used server-side. Route through /api/v1/ai/* endpoints."
  exit 1
fi

# Also check for require('openai')
if grep -r "require('openai')" client/src --exclude-dir=node_modules 2>/dev/null; then
  echo "❌ Error: Direct OpenAI requires found in client code!"
  echo "OpenAI must only be used server-side. Route through /api/v1/ai/* endpoints."
  exit 1
fi

# Check for VITE_OPENAI in env files
if grep "VITE_OPENAI" .env* 2>/dev/null; then
  echo "❌ Error: VITE_OPENAI_API_KEY found in env files!"
  echo "OpenAI keys must not use VITE_ prefix (exposes to frontend)."
  echo "Use OPENAI_API_KEY in backend only."
  exit 1
fi

# Check for OpenAI in client package.json dependencies
if grep -E '"openai":\s*"' client/package.json 2>/dev/null; then
  echo "❌ Error: OpenAI package found in client dependencies!"
  echo "Remove openai from client/package.json - it should only be in server dependencies."
  exit 1
fi

echo "✅ No OpenAI imports found in client code"

# Run tests
npm test