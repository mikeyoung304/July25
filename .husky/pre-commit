#!/usr/bin/env bash
. "$(dirname "$0")/_/husky.sh"

echo "[husky] pre-commit: quick typecheck + lint"

# Allow skipping on local emergency fixes:
#   SKIP_PRECOMMIT_TS=1 git commit -m "..."
if [ -z "$SKIP_PRECOMMIT_TS" ]; then
  npm run typecheck:quick --workspaces || exit 1
fi

npm run lint --workspaces --silent || exit 1

# Validate GitHub Actions workflows
if git diff --cached --name-only | grep -q "^\.github/workflows/.*\.yml$"; then
  echo "üîç Workflow files detected, validating..."
  npm run validate:workflows
fi

# Check for schema drift if staging migration files
if git diff --cached --name-only | grep -q "^supabase/migrations/.*\.sql$"; then
  echo "üîç Migration files detected, checking schema sync..."

  if command -v supabase &> /dev/null; then
    if ! supabase db diff --linked > /dev/null 2>&1; then
      echo ""
      echo "‚ö†Ô∏è  WARNING: You are committing migration files, but schema drift detected!"
      echo ""
      echo "Migrations should be deployed BEFORE committing:"
      echo "  supabase db push --linked"
      echo ""
      echo "To commit anyway: git commit --no-verify"
      echo ""
      exit 1
    fi
    echo "‚úÖ Schema in sync"
  else
    echo "‚ö†Ô∏è  Supabase CLI not found, skipping schema check"
    echo "   Install: brew install supabase/tap/supabase"
  fi
fi
