#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-commit checks (fast mode)..."

# Guard against compiled JS in /shared
echo "ğŸ›¡ï¸  Checking for compiled JS in /shared..."
npm run check:no-shared-js
if [ $? -ne 0 ]; then
  echo "âŒ Compiled JS detected in /shared. Please fix before committing."
  exit 1
fi

# Run TypeScript check (fast, no emit)
echo "ğŸ“˜ Running TypeScript check..."
npm run typecheck
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript errors found. Please fix before committing."
  exit 1
fi

# Check for console.log statements (except in test/debug files)
echo "ğŸ” Checking for console.log statements..."
files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' | grep -v -E '(test|spec|debug|mock)' | xargs grep -l 'console\.log' 2>/dev/null)
if [ ! -z "$files" ]; then
  echo "âš ï¸  Warning: console.log statements found in:"
  echo "$files"
  echo "Consider using the logger service instead."
fi

# Check for 'any' types in new code
echo "ğŸ” Checking for 'any' types in staged files..."
any_count=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' | xargs grep -c ': any' 2>/dev/null | awk -F: '{sum+=$2} END {print sum}')
if [ "$any_count" -gt "0" ]; then
  echo "âš ï¸  Warning: $any_count 'any' types found in staged files"
  echo "Consider using proper types for better type safety"
fi

echo "ğŸ¯ Running scoped auth-orders checks..."
npm run precommit:auth-orders
if [ $? -ne 0 ]; then
  echo "âŒ Auth-orders checks failed. Please fix before committing."
  exit 1
fi

# Check docs front-matter for active docs
echo "ğŸ“š Checking active docs metadata..."
if [ -f docs/DOCS_INDEX.md ]; then
  ACTIVE_DOCS=$(grep -oE '\[docs/[^]]+\.md\]' docs/DOCS_INDEX.md | sed 's/[][]//g')
  for doc in $ACTIVE_DOCS; do
    if [ -f "$doc" ]; then
      if ! grep -q '^last_verified_date:' "$doc"; then
        echo "âŒ $doc missing last_verified_date in front-matter"
        exit 1
      fi
      if ! grep -q '^last_verified_commit:' "$doc"; then
        echo "âŒ $doc missing last_verified_commit in front-matter"
        exit 1
      fi
    fi
  done
fi

echo "âœ… Pre-commit checks passed! (Full tests run in CI)"