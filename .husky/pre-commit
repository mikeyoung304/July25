#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üöÄ Running pre-commit checks (fast mode)..."

# Guard against compiled JS in /shared
echo "üõ°Ô∏è  Checking for compiled JS in /shared..."
npm run check:no-shared-js
if [ $? -ne 0 ]; then
  echo "‚ùå Compiled JS detected in /shared. Please fix before committing."
  exit 1
fi

# Run TypeScript check (fast, no emit)
echo "üìò Running TypeScript check..."
npm run typecheck
if [ $? -ne 0 ]; then
  echo "‚ùå TypeScript errors found. Please fix before committing."
  exit 1
fi

# Check for console.log statements (except in test/debug files)
echo "üîé Checking for console.log statements..."
files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' | grep -v -E '(test|spec|debug|mock)' | xargs grep -l 'console\.log' 2>/dev/null)
if [ ! -z "$files" ]; then
  echo "‚ö†Ô∏è  Warning: console.log statements found in:"
  echo "$files"
  echo "Consider using the logger service instead."
fi

# Check for 'any' types in new code
echo "üîé Checking for 'any' types in staged files..."
any_count=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' | xargs grep -c ': any' 2>/dev/null | awk -F: '{sum+=$2} END {print sum}')
if [ "$any_count" -gt "0" ]; then
  echo "‚ö†Ô∏è  Warning: $any_count 'any' types found in staged files"
  echo "Consider using proper types for better type safety"
fi

echo "‚úÖ Pre-commit checks passed! (Full tests run in CI)"