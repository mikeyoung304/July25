================================================================================
VERCEL DEPLOYMENT PROBLEM - QUICK REFERENCE GUIDE
================================================================================

CURRENT STATE
=============
âœ… System is WORKING - deployments succeed
âš ï¸  System is FRAGILE - root causes not fully addressed
ðŸ“Š Risk Level: MEDIUM - could recur with next build config change

WHAT .VERCEL FILES EXIST
=========================
/root/.vercel/project.json
â”œâ”€â”€ projectName: "july25-client" âœ… CORRECT
â”œâ”€â”€ projectId: prj_iG6YRjjsMePUoGPmzZxnKUwYfH0n
â””â”€â”€ orgId: team_OesWPwxqmdOsNGDnz0RqS4kA

GHOST PROJECTS IN HISTORY (CLEANED UP)
=======================================
- server/.vercel/ (commit 64a8ed58) - DELETED âœ…
- Reason: Ran 'vercel link' from wrong directory
- Would have caused: server deployed to Vercel instead of Render

WHY PROBLEMS KEEP HAPPENING
=============================
1. LOCAL â‰  VERCEL
   - Local: npm adds workspace binaries to PATH
   - Vercel: isolated workspace, no PATH modification
   - Result: Scripts work locally, fail in Vercel

2. TRIAL & ERROR DEBUGGING
   - Nov 17: Single commit d9b20189 broke build
   - Result: 13 commits, 8 hours, 15-20 tokens created
   - Could have been: 15 minutes with proper diagnosis

3. DISABLED SAFEGUARDS
   - vercel-guard.yml exists but DISABLED
   - Would have prevented server/.vercel creation

4. ENVIRONMENT SPRAWL
   - 15+ .env files (should be 2)
   - Overlapping .gitignore rules
   - Newline contamination bugs

5. BUILD SCRIPT INCONSISTENCY
   - Root: npm run build --workspace=X (correct)
   - Shared: bare tsc (fragile)
   - Client: npm exec -- vite (correct)
   - = Inconsistent, error-prone

BEFORE PUSHING CODE
====================
[ ] Run from project ROOT (not a subdirectory)
[ ] Test build: npm run build:vercel
[ ] Run tests: npm test
[ ] Run typecheck: npm run typecheck
[ ] Check for changes to:
    - vercel.json
    - package.json (build scripts)
    - .vercel/project.json
    - Build configuration

IF DEPLOYMENT FAILS
===================
1. Check error message carefully
2. If "command not found" (tsc, vite, etc):
   â†’ Problem: PATH resolution in Vercel isolated workspace
   â†’ Solution: Use npm run build --workspace=X pattern
   â†’ Time to fix: 15 minutes (not 8 hours!)

3. If "command not found" with multiple attempts:
   â†’ Problem: Trial & error approach
   â†’ Solution: Run git bisect to find breaking commit
   â†’ Then test fix in clean environment

VERCEL PROJECT STRUCTURE
==========================
Service          Platform    Config File
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Client (React)   Vercel      .vercel/project.json
Server (Node)    Render      render.yaml
Database         Supabase    supabase/
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

CRITICAL FILES TO WATCH
========================
.vercel/project.json         â†’ Only july25-client allowed
vercel.json                  â†’ Build instructions
package.json                 â†’ build:vercel script
shared/package.json          â†’ build script
client/package.json          â†’ build script
.env                         â†’ Local only (git ignored)
.env.example                 â†’ Template (git tracked)
.github/workflows-disabled/  â†’ vercel-guard.yml (SHOULD BE ENABLED)

NEVER DO THIS
=============
âœ— Run deployment commands from subdirectories (enforced by script)
âœ— Use bare "tsc" or "vite" commands (use npm run build --workspace=X)
âœ— Run "vercel link" from server/ or client/ directories
âœ— Create new .vercel directories
âœ— Disable deployment guard workflows
âœ— Allow OAuth flows in CI/CD (always use explicit --token)

ALWAYS DO THIS
==============
âœ“ Work from project root
âœ“ Test build locally: npm run build:vercel
âœ“ Use npm run build --workspace=X pattern
âœ“ Pass explicit --token to vercel commands
âœ“ Keep .env files consolidated
âœ“ Document deployment target (which platform?)

QUICK COMMANDS
==============
Check current Vercel project:
  cat .vercel/project.json | grep projectName

Check for rogue .vercel directories:
  find . -name ".vercel" -type d | grep -v "^\.\/.vercel$"

Test build (before pushing):
  npm run build:vercel

Safe manual deploy (if needed):
  npm run deploy

Check GitHub workflows:
  ls .github/workflows/*.yml | wc -l

TO-DO LIST (PRIORITY)
======================
P0 (Today)
  [ ] Verify VITE_DEMO_PANEL=false in production
  [ ] Audit Vercel tokens (max 3 active)
  [ ] Confirm only july25-client project exists

P1 (This Week)
  [ ] Re-enable vercel-guard.yml workflow
  [ ] Consolidate .env files (15 â†’ 2)
  [ ] Fix .gitignore conflicts
  [ ] Standardize build scripts

P2 (This Month)
  [ ] Create clean-environment build test
  [ ] Document deployment matrix
  [ ] Consolidate npm scripts (90+ â†’ 50-60)

HISTORICAL TIMELINE
====================
2025-09-24  Initial Vercel setup (july25-client)
2025-10-26  GHOST PROJECT: server/.vercel created (now deleted)
2025-11-06  Environment variable contamination (newlines)
2025-11-11  Found 15+ .env files, secrets exposed
2025-11-15  Massive 154-file infrastructure commit
2025-11-17  CATASTROPHIC: 8-hour incident, 13 commits, 15-20 tokens created
2025-11-18+ Recent fixes stabilizing build system
2025-11-24  This comprehensive analysis completed

LESSONS LEARNED
================
1. Local â‰  Vercel (test in clean environment, not just local)
2. Git bisect > trial & error (15 min vs 8 hours)
3. Safeguards work (vercel-guard.yml would have prevented ghost)
4. Token management matters (OAuth flow creates security debt)
5. Disabled safeguards cause problems (re-enable vercel-guard.yml)

FULL ANALYSIS
=============
For complete technical details, see:
â†’ VERCEL_DEPLOYMENT_ANALYSIS_SUMMARY.md (this directory)
â†’ docs/archive/2025-11/VERCEL_DEPLOYMENT_COMPREHENSIVE_ANALYSIS.md

================================================================================
Last updated: 2025-11-24
Status: Current system working but fragile
Risk: Medium (could recur with build config changes)
