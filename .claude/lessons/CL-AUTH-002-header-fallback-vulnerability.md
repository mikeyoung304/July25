# CL-AUTH-002: X-Restaurant-ID Header Fallback Vulnerability

**Severity:** P1 | **Type:** Security | **Fixed:** 2025-11-25

## Problem

Auth middleware allowed falling back to `X-Restaurant-ID` header when JWT token was missing `restaurant_id` claim. This allowed authenticated users to access data from ANY restaurant by spoofing the header.

## Bug Pattern

```typescript
// VULNERABLE: Header fallback allows cross-tenant access
req.restaurantId = strictAuth
  ? decoded.restaurant_id
  : (decoded.restaurant_id || (req.headers['x-restaurant-id'] as string));

// ATTACK: Authenticated user sends forged header
curl -H "Authorization: Bearer valid_token" \
     -H "X-Restaurant-ID: victim-restaurant-uuid" \
     /api/v1/orders
// Returns orders from victim restaurant!
```

## Fix Pattern

```typescript
// SECURE: Only trust restaurant_id from JWT token
req.restaurantId = decoded.restaurant_id;

// For public endpoints (unauthenticated), use explicit lookup:
// 1. Validate restaurant exists via database query
// 2. Only expose public data (menu, hours)
// 3. Never trust header for tenant context
```

## Affected Files

- `server/src/middleware/auth.ts` - authenticate(), optionalAuth()
- `server/src/middleware/restaurantAccess.ts` - validateRestaurantAccess()

## Prevention Checklist

- [ ] Never fall back to request headers for tenant identity
- [ ] JWT `restaurant_id` claim is the ONLY source of tenant context for authenticated requests
- [ ] Public endpoints must validate restaurant via database lookup, not header trust
- [ ] Test with forged headers to verify isolation

## Detection

- Security audit finds header fallback pattern
- Cross-tenant data leak reports
- Unusual access patterns (one user accessing many restaurants)

## Related

- CL-AUTH-001: STRICT_AUTH Environment Drift
