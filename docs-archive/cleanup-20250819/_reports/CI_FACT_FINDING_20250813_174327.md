# CI Pipeline Fact Finding Report
**Date**: 2025-08-13 17:43:27  
**Branch**: 86BP-phase2-openai  
**SHA**: 584e0a2  
**PR**: #7 (https://github.com/mikeyoung304/July25/pull/7)

## Executive Summary
All PR-triggered CI workflows are failing due to:
1. **Blank page issue**: Preview server starts but app doesn't render content (NO_FCP error)
2. **Process management**: Incorrect subshell usage causing preview server to potentially exit
3. **Legacy CI**: Main CI workflow runs unnecessarily on PRs alongside specialized workflows

## Workflow Inventory

| Workflow | Trigger | Status | Issue |
|----------|---------|--------|-------|
| **ci.yml** | push (main, develop), PR | ❌ FAILING | Runs on PRs (redundant), uses port 3002 |
| **frontend-ci.yml** | PR (client/**) | ✅ PASSING | Build succeeds |
| **playwright-smoke.yml** | PR (client/**) | ❌ FAILING | Blank page, text not found |
| **lighthouse-performance.yml** | PR (client/**) | ❌ FAILING | NO_FCP error |
| **deploy-smoke.yml** | push (main) | N/A | Post-deploy only |

## Failed Runs Analysis

### Most Recent Failures (2025-08-13)
- **Run 16949251649** (Lighthouse): NO_FCP - page doesn't paint content
- **Run 16949251641** (Playwright): Expected text "Fresh, Healthy, Local" not found
- **Run 16949251637** (CI): Job setup failure (redundant workflow)

### Root Causes Identified

#### 1. Preview Server Process Management ❌
**Issue**: Subshell with `&` exits immediately
```bash
# INCORRECT (current)
(npm run preview -- --host 127.0.0.1 --port 4173 & echo $! > /tmp/preview.pid) &

# CORRECT (fixed)
npm run preview -- --host 127.0.0.1 --port 4173 > /tmp/preview.log 2>&1 &
echo $! > /tmp/preview.pid
```

#### 2. Legacy CI Workflow ❌
- Still triggers on PRs despite having specialized workflows
- References non-existent port 3002
- Creates duplicate test runs

## Local Reproduction Results

### Environment
- Node: v24.2.0
- npm: 11.3.0
- OS: macOS Darwin 24.5.0

### Test Results
```bash
✅ Build: SUCCESS (4.11s, warnings about chunk size)
✅ Preview Server: Started on http://127.0.0.1:4173
❌ Playwright Tests: 3/4 FAILED (blank page issue)
✅ No Console Errors: 1/4 PASSED
```

### Key Findings
1. **HTML served correctly**: `<title>MACON Restaurant AI...</title>` present
2. **JavaScript bundles load**: `/assets/index-CBEVQHzE.js` served
3. **React content missing**: Text "Fresh, Healthy, Local" not in DOM
4. **Server stays alive locally**: Process management works outside CI

## Verification Checklist

| Assumption | Status | Evidence |
|------------|--------|----------|
| Node setup before npm | ✅ | actions/setup-node@v4 runs first |
| Working directory set | ✅ | All steps use `working-directory: ./client` |
| Playwright browsers installed | ✅ | `npx playwright install --with-deps chromium` |
| Preview on 127.0.0.1:4173 | ✅ | Correct host/port configured |
| Wait-on used | ❌ | Loop checks curl, no npx wait-on |
| Root vercel.json absent | ✅ | No conflicting config |
| Shared module configured | ✅ | `@rebuild/shared` alias present |
| BASE_URL fallback works | ✅ | Defaults to http://127.0.0.1:4173 |

## Proposed Remediation

### 1. Fix Preview Server Management (HIGH PRIORITY)
**Files**: `.github/workflows/playwright-smoke.yml`, `.github/workflows/lighthouse-performance.yml`
- Fixed subshell process management
- Added process health checks
- Added debug output for server response

### 2. Disable Legacy CI on PRs (MEDIUM PRIORITY)
**File**: `.github/workflows/ci.yml`
- Commented out PR trigger (lines 6-8)
- Workflow still runs on push to main/develop

### 3. Enhanced Debugging (LOW PRIORITY)
- Added server response logging
- Added process death detection
- Added preview.log capture on failure

## Files Modified

```
.github/workflows/ci.yml                  | Lines 3-8
.github/workflows/playwright-smoke.yml    | Lines 42-74
.github/workflows/lighthouse-performance.yml | Lines 42-73
```

## Artifacts Generated

- `docs/_reports/artifacts/gh-run-list.json` - Complete run history
- `docs/_reports/artifacts/gh-run-logs.txt` - Failing run logs
- `docs/_reports/artifacts/gh-run-fail-steps.json` - Failure step details
- `docs/_reports/artifacts/proposed.diff` - Git diff of fixes
- `docs/_reports/artifacts/*.yml` - Workflow backups

## Next Steps

1. **Immediate**: Commit and push fixes to stabilize CI
2. **Investigation**: Why React app renders blank in CI but works locally
3. **Consider**: Adding `npx wait-on` instead of curl loop
4. **Long-term**: Consolidate or remove legacy CI workflow entirely

## Summary

**What failed**: Lighthouse (NO_FCP), Playwright (text not found), CI (redundant)  
**Why**: Preview server process management issue + blank page rendering  
**Fixed**: Process management, disabled legacy CI on PRs, added debugging  
**Local tests**: Build passes, but same blank page issue reproduced  
**Confidence**: MEDIUM - fixes address process issues but root cause of blank page needs investigation

---
*Generated by CI Architect on 2025-08-13*